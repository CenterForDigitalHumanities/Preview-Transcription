<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview Transcription</title>
    <style>
        body {
            font-family: v-sans, system-ui, -apple-system, "system-ui", "Segoe UI", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: rgb(254, 248, 228);
        }

        #transcription {
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-height: 700px;
            overflow-y: auto;
            padding: 5px 20px;
            scrollbar-gutter: stable both-edges;
        }

        .transcription-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            border-radius: 4px;
            padding: 5px 14px;
            background-color: white;
            font-size: 15px;
            line-height: 1.5;
            border: 1px solid rgb(0, 90, 140);
            color: rgb(0, 90, 140);
            cursor: pointer;
            font-weight: 500;
        }

        .transcription-item strong {
            color: #005a8c;
            min-width: 25px;
            text-align: right;
            flex-shrink: 0;
        }

        .transcription-item.selected {
            border-left: 5px solid rgb(0, 90, 140);
            box-shadow: 0 0 12px rgba(0, 90, 140, 0.8);
        }

        #transcription .empty {
            text-align: center;
            padding: 20px;
            color: #777;
            font-style: italic;
        }

        .copy-icon-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .copy-icon {
            width: 20px;
            height: 20px;
            cursor: pointer;
            opacity: 0.7;
        }

        .copy-icon:hover {
            opacity: 1;
        }

        .copied-text {
            font-size: 14px;
            color: #005a8c;
            font-weight: bold;
            margin: 0;
        }

        .transcription-input {
            border: none;
            background: transparent;
            font-size: 15px;
            line-height: 1.5;
            color: rgb(0, 90, 140);
            font-weight: 500;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="transcription">
        <div class="empty">Loading...</div>
    </div>
    <script>
        window.addEventListener("message", async event => {
            if (!event?.data) return
            const container = document.getElementById("transcription")
            if (event.data.type === "MANIFEST_CANVAS_ANNOTATIONPAGE_ANNOTATION") {
                try {
                    if (!event.data.annotationPage) return
                    const response = await fetch(event.data.annotationPage, { cache: "no-store" })
                    if (!response.ok) throw new Error("Failed to fetch annotations")
                    const annotations = await response.json()
                    if (!annotations?.items?.length) {
                        container.innerHTML = `<div class="empty">No transcription available.</div>`
                        return
                    }

                    const items = await Promise.all(
                        annotations.items.map(async anno => {
                            if (!anno?.id) return ""
                            try {
                                const res = await fetch(anno.id)
                                if (!res.ok) return ""
                                const item = await res.json()
                                return item?.body?.value || item?.body?.[0]?.value || ""
                            } catch (err) {
                                return ""
                            }
                        })
                    )

                    container.innerHTML = ""
                    
                    const copyContainer = document.createElement("div")
                    copyContainer.className = "copy-icon-container"

                    const copyIcon = document.createElement("img")
                    copyIcon.className = "copy-icon"
                    copyIcon.src = "./assets/copy.png"
                    copyIcon.alt = "Copy Icon"

                    copyContainer.appendChild(copyIcon)
                    container.appendChild(copyContainer)
                    copyContainer.addEventListener("click", () => {
                        const textToCopy = items.map((item,index) => `${index + 1}. ${item}`).join("\n")
                        const textArea = document.createElement("textarea")
                        textArea.value = textToCopy
                        document.body.appendChild(textArea)
                        textArea.select()
                        try {
                            document.execCommand('copy')
                        } catch (err) {
                            console.error("Failed to copy transcription.")
                        }
                        document.body.removeChild(textArea)
                        copyContainer.innerHTML = "<p class='copied-text'>âœ… Copied</p>"
                        setTimeout(() => {
                            copyContainer.innerHTML = ""
                            copyContainer.appendChild(copyIcon)
                        }, 2000)
                    })

                    items.forEach((item,index) => {
                        const div = document.createElement("div")
                        div.className = "transcription-item"
                        div.dataset.lineid = annotations.items[index]?.id || ""
                        div.innerHTML = `<strong>${index + 1}.</strong><input type="text" value="${item}" class="transcription-input"/>`
                        container.appendChild(div)
                    })

                    container.querySelectorAll(".transcription-input").forEach((input, index) => {
                        input.addEventListener("input", (e) => {
                            const target = e.target
                            window.parent?.postMessage({ 
                                type: "UPDATE_LINE_TEXT", 
                                lineIndex: index, 
                                text: target.value 
                            }, "*")
                        })
                    })

                    container.querySelectorAll(".transcription-item").forEach((item, index) => {
                        item.addEventListener("click", () => {
                            container.querySelectorAll(".transcription-item").forEach(i => i.classList.remove("selected"))
                            item.classList.add("selected")
                            window.parent?.postMessage({ 
                                type: "RETURN_LINE_ID", 
                                lineid: item.dataset.lineid || null, 
                                lineIndex: index 
                            }, "*")
                        })
                    })
                } catch (err) {
                    console.error("Error processing annotations:", err)
                }
            }
            if (event.data.type === "CURRENT_LINE_INDEX") {
                const lineId = event.data.lineId
                await new Promise(resolve => setTimeout(resolve, 1000))
                const el = document.querySelector(`.transcription-item[data-lineid="${lineId}"]`)
                if (el) {
                    el.classList.add('selected')
                    el.setAttribute('aria-selected', 'true')
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' })
                }
            }
            if (event.data.type === "SELECT_ANNOTATION") {
                const lineId = event.data.lineId
                document.querySelectorAll(`.transcription-item`).forEach(box => {
                    if (box.getAttribute('data-lineid') !== lineId) {
                        box.classList.remove('selected')
                        box.setAttribute('aria-selected', 'false')
                    }
                })

                const el = document.querySelector(`.transcription-item[data-lineid="${lineId}"]`)
                if (el) {
                    el.classList.add('selected')
                    el.setAttribute('aria-selected', 'true')
                    el.scrollIntoView({ behavior: 'smooth', block: 'center' })
                }
            }
        })
    </script>
</body>
</html>