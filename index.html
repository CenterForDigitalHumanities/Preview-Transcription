<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Preview Transcription</title>
    <style>
        body {
            font-family: v-sans, system-ui, -apple-system, "system-ui", "Segoe UI", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            background-color: rgb(254, 248, 228);
        }

        #transcription {
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            max-height: 700px;
            overflow-y: auto;
            padding: 5px 20px;
            scrollbar-gutter: stable both-edges;
        }

        .transcription-item {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            border-radius: 4px;
            padding: 5px 14px;
            background-color: white;
            font-size: 15px;
            line-height: 1.5;
            border: 1px solid rgb(0, 90, 140);
            color: rgb(0, 90, 140);
            cursor: pointer;
            font-weight: 500;
        }

        .transcription-item strong {
            color: #005a8c;
            min-width: 25px;
            text-align: right;
            flex-shrink: 0;
        }

        .transcription-item.selected {
            border-left: 5px solid rgb(0, 90, 140);
            box-shadow: 0 0 12px rgba(0, 90, 140, 0.8);
        }

        #transcription .empty {
            text-align: center;
            padding: 20px;
            color: #777;
            font-style: italic;
        }

        .copy-icon-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        .copy-icon {
            width: 25px;
            height: 25px;
            cursor: pointer;
            opacity: 0.7;
        }

        .copy-icon:hover {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="transcription">
        <div class="empty">Loading...</div>
    </div>
    <script>
        window.addEventListener("message", async event => {
            if (!event?.data) return
            const container = document.getElementById("transcription")
            if (event.data.type === "ANNOTATIONS") {
                try {
                    if (!event.data.annotations) return
                    const response = await fetch(event.data.annotations, { cache: "no-store" })
                    if (!response.ok) throw new Error("Failed to fetch annotations")
                    const annotations = await response.json()
                    if (!annotations?.items?.length) {
                        container.innerHTML = `<div class="empty">No transcription available.</div>`
                        return
                    }

                    const items = await Promise.all(
                        annotations.items.map(async anno => {
                            if (!anno?.id) return ""
                            try {
                                const res = await fetch(anno.id)
                                if (!res.ok) return ""
                                const item = await res.json()
                                return item?.body?.value || item?.body?.[0]?.value || ""
                            } catch (err) {
                                return ""
                            }
                        })
                    )

                    container.innerHTML = ""
                    
                    const copyContainer = document.createElement("div")
                    copyContainer.className = "copy-icon-container"

                    const copyIcon = document.createElement("img")
                    copyIcon.className = "copy-icon"
                    copyIcon.src = "./assets/copy.png"
                    copyIcon.alt = "Copy Icon"

                    copyContainer.appendChild(copyIcon)
                    container.appendChild(copyContainer)
                    copyContainer.addEventListener("click", () => {
                        const textToCopy = items.map((item,index) => `${index + 1}. ${item}`).join("\n")
                        navigator.clipboard.writeText(textToCopy).catch(err => console.error("Failed to copy"))
                    })

                    items.forEach((item,index) => {
                        const div = document.createElement("div")
                        div.className = "transcription-item"
                        div.dataset.lineid = annotations.items[index]?.id || ""
                        div.innerHTML = `<strong>${index + 1}.</strong> <span>${item}</span>`
                        container.appendChild(div)
                    })

                    const first = container.querySelector(".transcription-item")
                    if (first) first.classList.add("selected")
                    container.querySelectorAll(".transcription-item").forEach((item,index) => {
                        item.addEventListener("click", () => {
                            container.querySelectorAll(".transcription-item").forEach(i => i.classList.remove("selected"))
                            item.classList.add("selected")
                            window.parent?.postMessage({ 
                                type: "RETURN_LINE_ID", 
                                lineid: item.dataset.lineid || null, lineIndex: index 
                            }, "*")
                        })
                    })
                } catch (err) {
                    console.error("Error processing annotations:", err)
                }
            }
            if (event.data.type === "SELECT_ANNOTATION") {
                const index = event.data.lineId
                if (typeof index !== "number") return
                const items = document.querySelectorAll(".transcription-item")
                const item = items[index]
                if (item) {
                    items.forEach(i => i.classList.remove("selected"))
                    item.classList.add("selected")
                    item.scrollIntoView({ behavior: "smooth", block: "center" })
                }
            }
        })
    </script>
</body>
</html>